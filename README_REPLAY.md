# 牌谱播放器使用说明

## 功能说明

这个Python脚本可以逐步播放牌谱文件，通过API接口在实时游戏界面中展示牌谱内容。

## 前置要求

### 1. 启动后端服务器
```bash
cd backend
python start_server.py
```

### 2. 启动前端服务器
```bash
cd frontend  
npm start
```

### 3. 确保Python环境
需要安装 `requests` 库：
```bash
pip install requests
```

## 使用方法

### 基本用法
```bash
python replay_player.py model/first_hand/sample_mahjong_game_final.json
```

### 自定义播放速度
```bash
python replay_player.py model/first_hand/sample_mahjong_game_final.json 1.5
```
- 第二个参数是步骤间隔时间（秒），默认为2秒
- 数值越小播放越快，建议范围：0.5-5秒

## 播放流程

### 第一阶段：初始化
1. ✅ 检查API服务器连接
2. ✅ 重置游戏状态
3. ✅ 设置各玩家定缺
4. ✅ 设置各玩家初始手牌

### 第二阶段：操作播放
逐步执行牌谱中的每个操作：
- 🎲 **摸牌** - 玩家从牌堆摸牌
- 🗑️ **弃牌** - 玩家弃出牌
- 💥 **碰牌** - 玩家碰其他玩家的牌
- ⚡ **杠牌** - 玩家杠牌（暗杠/直杠/加杠）
- 🏆 **胡牌** - 玩家点炮胡牌
- 🙌 **自摸** - 玩家自摸胡牌

## 界面对应关系

播放时，实时游戏界面的布局与牌谱回放界面一致：

### 左侧区域（3列）
- **麻将桌面区域** - 显示四人游戏桌面、手牌、弃牌、碰杠牌
- **所有麻将牌显示区域** - 显示所有牌及剩余数量

### 右侧区域（1列）  
- **智能分析面板** - 显示AI分析结果和建议

## 关键功能特性

### 手牌数量逻辑
- **普通弃牌**：每次弃牌前自动摸一张牌，确保手牌数量正确变化
- **碰牌后弃牌**：碰牌时减少2张手牌，弃牌时再减少1张，无需额外摸牌
- **杠牌后弃牌**：杠牌操作本身包含摸牌逻辑，弃牌时不额外摸牌
- **牌谱假设**：每次弃牌都是刚摸的牌（符合血战到底规则）

### 游戏结束展示
- **显示所有手牌**：游戏结束时会显示所有玩家的手牌
- **真实手牌数据**：从牌谱文件中提取真实的最终手牌，确保与牌谱回放界面一致
- **胜利状态显示**：正确显示自摸、点炮胡牌等胜利状态和样式
- **胡牌牌显示**：显示具体的胡牌牌面和胡牌类型

## 注意事项

1. **必须先启动前后端服务器**，否则脚本会提示连接失败
2. **在前端切换到"实时游戏"模式**，这样才能看到播放效果
3. 播放过程中可以观察右侧的智能分析面板，看AI的实时分析
4. 如果某个操作失败，脚本会停止播放并显示错误信息

## 脚本输出示例

```
🎬 开始播放牌谱: model/first_hand/sample_mahjong_game_final.json
✅ 游戏状态已重置
✅ 玩家0定缺万设置成功
✅ 玩家1定缺条设置成功
✅ 玩家2定缺筒设置成功
✅ 玩家3定缺万设置成功

📂 设置玩家0初始手牌...
✅ 玩家0添加手牌2万
✅ 玩家0添加手牌2条
...

⏰ 初始化完成，3秒后开始播放操作...

🎯 步骤1: 玩家1 discard 3条
✅ 玩家1弃牌3条

🎯 步骤2: 玩家2 discard 3条  
✅ 玩家2弃牌3条

🎯 步骤3: 玩家3 discard 7万
✅ 玩家3弃牌7万

🎯 步骤4: 玩家2 peng 7万
✅ 玩家2碰牌7万(来源:玩家3)

...

🎉 牌谱播放完成！
✅ 牌谱播放成功完成
```

## 故障排除

### 连接失败
- 确保后端服务器已启动并监听8000端口
- 检查防火墙设置

### 操作失败
- 检查牌谱文件格式是否正确
- 确保游戏状态没有冲突

### 前端不显示
- 确保前端已启动并切换到"实时游戏"模式
- 刷新浏览器页面