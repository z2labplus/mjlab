# 麻将初始手牌推导器

## 概述

这是一个基于特定公式的麻将初始手牌推导工具，能够从不完整的牌谱（只知道部分玩家的初始手牌）推导出所有玩家的初始手牌，生成完整的游戏记录。

## 推导公式

```
最初的手牌 = 最后的手牌 + 碰牌中自己的牌 + 自己碰牌后的出牌 + 杠牌中自己的牌
```

### 公式组成部分

1. **最后的手牌**: 游戏结束时该玩家的手牌
2. **碰牌中自己的牌**: 碰牌操作中消耗的自己的牌（每次碰牌消耗2张）
3. **自己碰牌后的出牌**: 碰牌之后立即出的牌
4. **杠牌中自己的牌**: 杠牌操作中消耗的自己的牌（明杠3张，加杠1张）

## 使用方法

### 1. 命令行使用

```bash
# 基本用法
python mahjong_initial_hand_deducer.py input_file.json

# 指定输出文件
python mahjong_initial_hand_deducer.py input_file.json -o output_file.json
```

### 2. 直接运行测试

```bash
# 使用默认测试文件
python mahjong_initial_hand_deducer.py
```

### 3. 作为模块使用

```python
from mahjong_initial_hand_deducer import MahjongInitialHandDeducer

# 创建推导器实例
deducer = MahjongInitialHandDeducer("input_file.json")

# 运行推导
complete_replay = deducer.run_deduction("output_file.json")
```

## 输入文件格式

输入的JSON文件需要包含以下必要字段：

```json
{
  "first_hand": {
    "0": ["1万", "1万", "2万", "3万", "5万", "6万", "8万", "9万", "9万", "3筒", "6筒", "7筒", "8筒"]
  },
  "actions": [
    {"sequence": 1, "player_id": 0, "type": "discard", "tile": "7条"},
    {"sequence": 2, "player_id": 1, "type": "discard", "tile": "8万"},
    ...
  ],
  "final_hand": {
    "0": {
      "hand": ["5万", "6万", "8万", "8万", "6筒", "7筒", "8筒"],
      "melds": [
        {"type": "peng", "tile": ["9万", "9万", "9万"], "target_player": 1},
        {"type": "jiagang", "tile": ["1万", "1万", "1万", "1万"], "target_player": 3}
      ]
    },
    "1": {
      "hand": ["6筒", "7筒", "8筒", "9筒", "4条", "5条", "6条"],
      "melds": [
        {"type": "peng", "tile": ["3筒", "3筒", "3筒"], "target_player": 0},
        {"type": "peng", "tile": ["8条", "8条", "8条"], "target_player": 2}
      ]
    },
    ...
  }
}
```

### 必要字段说明

- `first_hand`: 至少包含一个已知玩家的初始手牌
- `actions`: 游戏动作序列，包含所有玩家的碰、杠、出牌等动作
- `final_hand`: 所有玩家的最终手牌和碰杠组合

## 输出文件格式

输出的完整牌谱会包含：

1. **游戏信息**: 包含推导说明和原始文件信息
2. **完整初始手牌**: 所有4个玩家的13张初始手牌
3. **推导方法说明**: 记录使用的公式和推导结果
4. **原始游戏数据**: 保持所有原始的动作序列和最终手牌

## 功能特点

### 1. 自动推导
- 基于数学公式自动计算未知玩家的初始手牌
- 支持碰牌、明杠、加杠等复杂操作的处理
- 自动验证推导结果是否为13张

### 2. 数据验证
- 检查输入数据格式的完整性
- 验证推导结果的合理性
- 提供详细的错误信息和调试输出

### 3. 灵活使用
- 支持命令行和模块两种使用方式
- 可以处理任意数量的已知玩家初始手牌
- 输出格式标准化，便于后续处理

## 示例

### 输入示例
只知道玩家0的初始手牌的不完整牌谱

### 输出示例
推导出所有4个玩家初始手牌的完整牌谱：

```
📊 推导总结:
  玩家0: 13张 ✅ (known)
  玩家1: 13张 ✅ (deduced)
  玩家2: 13张 ✅ (deduced)
  玩家3: 13张 ✅ (deduced)

🎉 推导成功！所有玩家都有13张初始手牌！
```

## 注意事项

1. **公式限制**: 当前推导基于特定公式，可能不适用于所有麻将变体
2. **数据质量**: 推导结果的准确性取决于输入数据的完整性和正确性
3. **13张验证**: 推导的初始手牌应该都是13张，如果不是可能需要调整算法或检查数据

## 技术细节

- **语言**: Python 3.6+
- **依赖**: 仅使用标准库，无外部依赖
- **编码**: UTF-8，支持中文麻将牌名
- **错误处理**: 完整的异常处理和用户友好的错误信息

## 许可证

此工具基于用户提供的推导公式开发，供学习和研究使用。